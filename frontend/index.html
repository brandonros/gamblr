<!doctype html>
<html>
  <head>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.18/c3.min.css">

      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

      <style type="text/css">
        .chart-container {
          height: 415px;
        }
      </style>
  </head>

  <body>
    <div class="row"></div>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.19.3/moment.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.18/c3.min.js"></script>

    <script type="text/javascript">
      function generatePriceChangeChart(bet) {
        var priceColumn = ['price'];
        var xColumn = ['x'];

        bet.priceChanges.forEach(function(change, index) {
          if (index === 0) {
            priceColumn.push(change.oldPrice);
            xColumn.push(moment(change.originallyScraped).format('YYYY-MM-DD hh:mm'));
          }

          priceColumn.push(change.newPrice);
          xColumn.push(moment(change.changed).format('YYYY-MM-DD hh:mm'));
        });

        c3.generate({
          bindto: `#price-chart-${bet.id}`,
          data: {
            x: 'x',
            xFormat: '%Y-%m-%d %H:%M',
            columns: [
              xColumn,
              priceColumn
            ]
          },
          axis: {
            x: {
              type: 'timeseries',
              localtime: true,
              tick: {
                format: '%Y-%m-%d %H:%M'
              }
            }
          }
        });
      }

      function generateHandicapChangeChart(bet) {
        var handicapColumn = ['handicap'];
        var xColumn = ['x'];

        bet.handicapChanges.forEach(function(change, index) {
          if (index === 0) {
            handicapColumn.push(change.oldHandicap);
            xColumn.push(moment(change.originallyScraped).format('YYYY-MM-DD hh:mm'));
          }

          handicapColumn.push(change.newHandicap);
          xColumn.push(moment(change.changed).format('YYYY-MM-DD hh:mm'));
        });

        c3.generate({
          bindto: `#handicap-chart-${bet.id}`,
          data: {
            x: 'x',
            xFormat: '%Y-%m-%d %H:%M',
            columns: [
              xColumn,
              handicapColumn
            ]
          },
          axis: {
            x: {
              type: 'timeseries',
              localtime: true,
              tick: {
                format: '%Y-%m-%d %H:%M'
              }
            }
          }
        });
      }

      (async function() {
        var db = await (await fetch('/backend/db.json')).json();

        var betsMap = {};

        db.bets.forEach(function(bet) {
          var key = bet.id;

          betsMap[key] = bet;
        });

        db.priceChanges.forEach(function(change) {
          var key = change.betHash;

          if (!betsMap[key].priceChanges) {
            betsMap[key].priceChanges = [];
          }

          betsMap[key].priceChanges.push(change);
        });

        db.handicapChanges.forEach(function(change) {
          var key = change.betHash;

          if (!betsMap[key].handicapChanges) {
            betsMap[key].handicapChanges = [];
          }

          betsMap[key].handicapChanges.push(change);
        });

        var betsWithChanges = Object.keys(betsMap).map(function(key) {
          return betsMap[key];
        }).filter(function(bet) {
          return (bet.priceChanges && bet.priceChanges.length) || (bet.handicapChanges && bet.handicapChanges.length);
        });

        betsWithChanges.forEach(function(bet) {
          $('.row').append(`<div class="col-sm-2 chart-container">
              <strong>${bet.game}<br>${bet.bet} ${bet.outcome}<br>${bet.startTime}</strong>
              <div id="price-chart-${bet.id}"></div>
              <div id="handicap-chart-${bet.id}"></div>
          </div>`);

          generatePriceChangeChart(bet);
          generateHandicapChangeChart(bet);
        });  
      })();
    </script>
  </body>
</html>