<!doctype html>
<html>
  <head>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.18/c3.min.css">

      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

      <style type="text/css">
        .chart-container {
          height: 720px;
        }
      </style>
  </head>

  <body>
    <div class="row"></div>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.19.3/moment.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.18/c3.min.js"></script>

    <script type="text/javascript">
      function generatePriceChangeChart(line, prices) {
        var priceColumn = ['price'];
        var xColumn = ['x'];

        prices.forEach(function(price, index) {
          priceColumn.push(price.price);
          xColumn.push(moment(price.time).format('YYYY-MM-DD hh:mm'));
        });

        c3.generate({
          bindto: `#price-chart-${line.id}`,
          data: {
            x: 'x',
            xFormat: '%Y-%m-%d %H:%M',
            columns: [
              xColumn,
              priceColumn
            ]
          },
          axis: {
            x: {
              type: 'timeseries',
              localtime: true,
              tick: {
                format: '%Y-%m-%d %H:%M'
              }
            }
          }
        });
      }

      function generateHandicapChangeChart(line, handicaps) {
        console.log(handicaps);

        var handicapColumn = ['handicap'];
        var xColumn = ['x'];

        handicaps.forEach(function(handicap, index) {
          handicapColumn.push(handicap.handicap);
          xColumn.push(moment(handicap.time).format('YYYY-MM-DD hh:mm'));
        });

        c3.generate({
          bindto: `#handicap-chart-${line.id}`,
          data: {
            x: 'x',
            xFormat: '%Y-%m-%d %H:%M',
            columns: [
              xColumn,
              handicapColumn
            ]
          },
          axis: {
            x: {
              type: 'timeseries',
              localtime: true,
              tick: {
                format: '%Y-%m-%d %H:%M'
              }
            }
          }
        });
      }

      (async function() {
        var db = await (await fetch('/backend/db.json')).json();

        db.lines.forEach(function(line) {
          var prices = db.prices.filter(function(price) {
            return line.id === price.lineHash;
          });

          var handicaps =  db.handicaps.filter(function(handicap) {
            return line.id === handicap.lineHash;
          });

          $('.row').append(`<div class="col-sm-2 chart-container">
              <strong>${line.game}<br>${line.betType} ${line.outcome}<br>${line.startTime}</strong>
              <div id="price-chart-${line.id}"></div>
              <div id="handicap-chart-${line.id}"></div>
            </div>`);

          generatePriceChangeChart(line, prices);

          if (handicaps.length) {
            generateHandicapChangeChart(line, handicaps);
          }
        });  
      })();
    </script>
  </body>
</html>