<!doctype html>
<html>
  <head>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.18/c3.min.css">

      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  </head>

  <body>
    <div class="row"></div>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.19.3/moment.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.18/c3.min.js"></script>

    <script type="text/javascript">
      function generateChart(bet) {
        var priceColumn = ['price'];
        var xColumn = ['x'];

        bet.changes.forEach(function(change, index) {
          if (index === 0) {
            priceColumn.push(change.oldPrice);
            xColumn.push(moment(change.originallyScraped).format('YYYY-MM-DD hh:mm'));
          }

          priceColumn.push(change.newPrice);
          xColumn.push(moment(change.changed).format('YYYY-MM-DD hh:mm'));
        });

        c3.generate({
          bindto: `#chart-${bet.id}`,
          data: {
            x: 'x',
            xFormat: '%Y-%m-%d %H:%M',
            columns: [
              xColumn,
              priceColumn
            ]
          },
          axis: {
            x: {
              type: 'timeseries',
              localtime: true,
              tick: {
                format: '%Y-%m-%d %H:%M'
              }
            }
          }
        });
      }

      (async function() {
        var db = await (await fetch('/backend/db.json')).json();

        var betsMap = {};

        db.bets.forEach(function(bet) {
          var key = bet.id;

          betsMap[key] = bet;
        });

        db.changes.forEach(function(change) {
          var key = change.betHash;

          if (!betsMap[key].changes) {
            betsMap[key].changes = [];
          }

          betsMap[key].changes.push(change);
        });

        var betsWithChanges = Object.keys(betsMap).map(function(key) {
          return betsMap[key];
        }).filter(function(bet) {
          return bet.changes && bet.changes.length;
        });

        betsWithChanges.sort(function(a, b) {
          return b.changes.length - a.changes.length;
        });

        betsWithChanges.forEach(function(bet) {
          bet.changes.sort(function(a, b) {
            return moment(a.changed).diff(b.changed, 'seconds');
          });

          $('.row').append(`<div class="col-sm-4"><h4>${bet.game} ${bet.bet} ${bet.outcome}<br>${bet.startTime}</h4> <div id="chart-${bet.id}"></div></div>`);

          generateChart(bet);
        });  
      })();
    </script>
  </body>
</html>